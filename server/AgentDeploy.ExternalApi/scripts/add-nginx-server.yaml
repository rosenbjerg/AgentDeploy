variables:
  hostname:
    type: string
  proxy:
    type: string
  websockets_enabled:
    type: boolean
    default_value: false
  websockets_route:
    type: string
    default_value: /
  websockets_keepalive:
    type: string
    regex: ^[0-9]+[mhd]$
    default: 10m
  max_body_size:
    type: string
    regex: ^[0-9]+[KMG]$
    default: 5M
  nginx_confd:
    type: string

show_script: true
show_output: true
command: |
  WEBSOCKETS="
    location $(websockets_route) {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection \"upgrade\";
      proxy_connect_timeout $(websockets_keepalive);
      proxy_send_timeout $(websockets_keepalive);
      proxy_read_timeout $(websockets_keepalive);
      proxy_pass $backend;
    }"

  SERVER_BLOCK="
  server {
    hostname: $(hostname);
    set $backend \"http://$(proxy)\";
    location / {
      proxy_pass $backend;
    }
    ${WEBSOCKETS}
  }"

  CONF_FILE="$(nginx_confd)/$(hostname).conf"
  printf "${SERVER_BLOCK}" > "${CONF_FILE}"
  docker exec nginx bash -c "nginx -t && nginx -s reload" || rm "$(CONF_FILE)"; exit 1